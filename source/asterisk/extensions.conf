; ====================================================================
; Autor: Antonio de Oliveira Junior
; Descricao: Configuracao principal do plano de discagem da central 
;            IPBX, menus de acesso principais, rotinas e pl. discagem.
; ====================================================================

; Modulos gerados automaticamente
#include extensions_ipbx_entradas.conf
#include extensions_ipbx_discagem.conf
#include extensions_digitos.conf
#include extensions_soletra.conf
#include extensions_aut_pesq.conf

; Modulo AES
#include extensions_aut_urarev.conf

; Modulos padrões
#include extensions_saudacao.conf
#include extensions_ura.conf

; Modulos
; #include ./modulo/extensions_pabx.conf
#include ./modulo/extensions_callcenter.conf
#include ./modulo/extensions_fax.conf

; Extencoes sem suporte
#include extensions_not_suported.conf

; Implantação da central telefonica
[globals]

; ROTINAS DE CONTROLE  -----------------------------------------------


[macro-limitadorPorRamal]

; Tratamento
exten => s,1,NoOp(Tratamento de limitacao de chamadas por ramal.)
exten => s,n,GotoIf($["${ARG3}" == "0"]?LIVRE)
exten => s,n,Set(GROUP()=${ARG1}_${ARG2})
exten => s,n,NoOp(${GROUP_COUNT(${ARG1}_${ARG2})})
exten => s,n,GotoIf($[${GROUP_COUNT(${ARG1}_${ARG2})} > ${ARG3}]?OCUPADO)
exten => s,n,MacroExit

; Livre
exten => s,n(LIVRE),MacroExit

; Retorna limitação de trafego
exten => s,n(OCUPADO),Busy()

[macro-desvio-programado]

; Rotina de desvio programado - Verifica se esta ativo
exten => s,1,NoOp("-------------------- Rotina de desvio programado do ramal. Verifica se esta ativo -------------------------------")
exten => s,2,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,3,MYSQL(Query resultid ${connid} select id_desvio, DATE_FORMAT(curdate(),"%w") as diasemana from ipbx_ramais where name = '${ARG1}')
exten => s,4,MYSQL(Fetch fetchid ${resultid} ID_DESVIO DIASEMANA)
exten => s,5,NoOp("${ID_DESVIO}")
exten => s,6,MYSQL(Clear ${resultid})
exten => s,7,MYSQL(Disconnect ${connid})
exten => s,8,GotoIf($["${ID_DESVIO}" != "NULL"]?desv_prog,1)
exten => s,9,MacroExit

; -- Desvio programado ativo - Verifica se eh data especifica ou feriado
exten => desv_prog,1,NoOp("-------------- Verificar se eh data especifica ou feriado. ------------------")
exten => desv_prog,2,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => desv_prog,3,MYSQL(Query resultid ${connid} select count(*) as dt_espec from ipbx_dt_especifica_feriado where dt_especifica = DATE(now()))
exten => desv_prog,4,MYSQL(Fetch fetchid ${resultid} DT_ESPEC)
exten => desv_prog,5,NoOp("${DT_ESPEC}")
exten => desv_prog,6,MYSQL(Clear ${resultid})
exten => desv_prog,7,MYSQL(Disconnect ${connid})
exten => desv_prog,8,GotoIf($["${DT_ESPEC}" == "1"]?desv_dt_espec,1)
exten => desv_prog,9,Goto(desv_diasemana,1)

; -- Programa desvio de data especifica
exten => desv_dt_espec,1,NoOp("-------------- Programa desvio de data especifica. ------------------")
exten => desv_dt_espec,2,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => desv_dt_espec,3,MYSQL(Query resultid ${connid} select time_format(hr_inicio_01, '%H:%i') as hr_inicio_01, time_format(hr_fim_01, '%H:%i') as hr_fim_01, dsv_01, time_format(hr_inicio_02, '%H:%i') as hr_inicio_02, time_format(hr_fim_02, '%H:%i') as hr_fim_02, dsv_02, time_format(hr_inicio_03, '%H:%i') as hr_inicio_03, time_format(hr_fim_03, '%H:%i') as hr_fim_03, dsv_03, time_format(hr_inicio_04, '%H:%i') as hr_inicio_04, time_format(hr_fim_04, '%H:%i') as hr_fim_04, dsv_04 from ipbx_horario_desv_ramais where diasemana is null and id_desvio = ${ID_DESVIO})
exten => desv_dt_espec,4,MYSQL(Fetch fetchid ${resultid} HR_INICIO_01 HR_FIM_01 DSV_01 HR_INICIO_02 HR_FIM_02 DSV_02 HR_INICIO_03 HR_FIM_03 DSV_03 HR_INICIO_04 HR_FIM_04 DSV_04)
exten => desv_dt_espec,5,NoOp("Retrieve")
exten => desv_dt_espec,6,MYSQL(Clear ${resultid})
exten => desv_dt_espec,7,MYSQL(Disconnect ${connid})
exten => desv_dt_espec,8,Goto(regra_horario,1)

; -- Programa desvio de dia da semana
exten => desv_diasemana,1,NoOp("-------------- Programa desvio de dia da semana. ------------------")
exten => desv_diasemana,2,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => desv_diasemana,3,MYSQL(Query resultid ${connid} select time_format(hr_inicio_01, '%H:%i') as hr_inicio_01, time_format(hr_fim_01, '%H:%i') as hr_fim_01, dsv_01, time_format(hr_inicio_02, '%H:%i') as hr_inicio_02, time_format(hr_fim_02, '%H:%i') as hr_fim_02, dsv_02, time_format(hr_inicio_03, '%H:%i') as hr_inicio_03, time_format(hr_fim_03, '%H:%i') as hr_fim_03, dsv_03, time_format(hr_inicio_04, '%H:%i') as hr_inicio_04, time_format(hr_fim_04, '%H:%i') as hr_fim_04, dsv_04 from ipbx_horario_desv_ramais where diasemana = ${DIASEMANA} and id_desvio = ${ID_DESVIO})
exten => desv_diasemana,4,MYSQL(Fetch fetchid ${resultid} HR_INICIO_01 HR_FIM_01 DSV_01 HR_INICIO_02 HR_FIM_02 DSV_02 HR_INICIO_03 HR_FIM_03 DSV_03 HR_INICIO_04 HR_FIM_04 DSV_04)
exten => desv_diasemana,5,NoOp("Retrieve")
exten => desv_diasemana,6,MYSQL(Clear ${resultid})
exten => desv_diasemana,7,MYSQL(Disconnect ${connid})
exten => desv_diasemana,8,Goto(regra_horario,1)

; -- Regra para o controle do horario
exten => regra_horario,1,NoOp("----------- Controle de horario ------- ")
exten => regra_horario,2,GotoIfTime(${HR_INICIO_01}-${HR_FIM_01}|*|*|*?DISC_${DSV_01},1)
exten => regra_horario,3,GotoIfTime(${HR_INICIO_02}-${HR_FIM_02}|*|*|*?DISC_${DSV_02},1)
exten => regra_horario,4,GotoIfTime(${HR_INICIO_03}-${HR_FIM_03}|*|*|*?DISC_${DSV_03},1)
exten => regra_horario,5,GotoIfTime(${HR_INICIO_04}-${HR_FIM_04}|*|*|*?DISC_${DSV_04},1)
exten => regra_horario,6,MacroExit

exten => _DISC_,1,MacroExit
exten => _DISC_NULL,1,MacroExit

exten => _DISC_XXX.,1,NoOp("-- Envia chamada --")
exten => _DISC_XXX.,2,Set(DISCAGEM=${EXTEN:5})
exten => _DISC_XXX.,3,Goto(s,1900)

; Ligação para outro ramal
exten => s,1900,GotoIf($[${LEN(${DISCAGEM})} > 4 ]?2000)
exten => s,1901,Goto(ramal-interno,${DISCAGEM},1)
exten => s,1902,MacroExit

; Ligação para destino fora da empresa
exten => s,2000,Set(CALLERID(num)=${ARG1})
exten => s,2001,Set(CDR(accountcode)=${conta})
exten => s,2002,Goto(${contexto},${DISCAGEM},1)
; ---------------------------

exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})
exten => h,3,NoOp()
exten => h,4,Hangup()


[macro-verif-ccusto-ativo]

exten => s,1,NoOp("ACCOUNTCODE: ${CDR(accountcode)}")
exten => s,2,GotoIf($["${CDR(accountcode)}" = ""]?ccusto-invalido,1)
exten => s,3,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,4,MYSQL(Query resultid ${connid} select flg_ativado from centrocusto where idt_custo = ${CDR(accountcode)})
exten => s,5,MYSQL(Fetch fetchid ${resultid} flg_ccusto_ativo)
exten => s,6,NoOp("${flg_ccusto_ativo}")
exten => s,7,MYSQL(Clear ${resultid})
exten => s,8,MYSQL(Disconnect ${connid})
exten => s,9,GotoIf($["${flg_ccusto_ativo}" = "1"]?:ccusto-naoativo,1)
exten => s,10,MacroExit

exten => ccusto-invalido,1,NoOp()
exten => ccusto-invalido,2,Playback(ipbx/ccusto_n_especif)
exten => ccusto-invalido,3,Hangup()

exten => ccusto-naoativo,1,NoOp()
exten => ccusto-naoativo,2,Playback(ipbx/ccusto_desativado)
exten => ccusto-naoativo,3,Hangup()

exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})
exten => h,3,NoOp()
exten => h,4,Hangup()

[macro-tratadeslchamada]

exten => s,1,Goto(s-${DIALSTATUS},1)
exten => s,2,MacroExit

; -- Tratamento para desligar
exten => s-BUSY,1,Busy(5)
exten => s-NOANSWER,1,Hangup(1)
exten => s-CHANUNAVAIL,1,Busy(5)
exten => i,1,Hangup(1)


[macro-identsaida]

exten => s,1,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,2,MYSQL(Query resultid ${connid} select id_saida from ipbx_ramais where id_saida is not NULL and id_saida != '' and name='${ARG1}')
exten => s,3,MYSQL(Fetch fetchid ${resultid} IDENTSAIDA)
exten => s,4,NoOp("${fetchid}")
exten => s,5,MYSQL(Clear ${resultid})
exten => s,6,MYSQL(Disconnect ${connid})
exten => s,7,GotoIf($["${fetchid}" = "0"]?9)
exten => s,8,Set(CALLERID(num)=${IDENTSAIDA})
exten => s,9,MacroExit

; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})
;exten => h,3,UnpauseQueueMember(,SIP/${CALLERID(num)})
exten => h,3,NoOp()
;exten => h,4,UnpauseQueueMember(,${RAMALPAUSADO})
exten => h,4,NoOp()


[macro-desvioddr]

exten => s,1,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,2,MYSQL(Query resultid ${connid} select desvio_ddr from ipbx_ramais where desvio_ddr is not NULL and desvio_ddr != '' and name='${ARG1}')
exten => s,3,MYSQL(Fetch fetchid ${resultid} DESVIODDR)
exten => s,4,NoOp("${fetchid}")
exten => s,5,MYSQL(Clear ${resultid})
exten => s,6,MYSQL(Disconnect ${connid})
exten => s,7,GotoIf($["${fetchid}" = "0"]?Retorna,1)
exten => s,8,Goto(ramal-interno,${DESVIODDR},1)

exten => Retorna,1,MacroExit

; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})
;exten => h,3,UnpauseQueueMember(,SIP/${CALLERID(num)})
exten => h,3,NoOp()
;exten => h,4,UnpauseQueueMember(,${RAMALPAUSADO})
exten => h,4,NoOp()

[macro-getid_menu]

; Argumento e o MCDU do canal
exten => s,1,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,n,MYSQL(Query resultid ${connid} select ccma.id_menu, ccma.id_fluxo from cc_menu_atend ccma where ccma.ramal_acesso='${ARG1}')
exten => s,n,MYSQL(Fetch fetchid ${resultid} id_menu id_fluxo)
exten => s,n,NoOp("${fetchid}")
exten => s,n,MYSQL(Clear ${resultid})
exten => s,n,MYSQL(Disconnect ${connid})
exten => s,n,GotoIf($["${fetchid}" = "0"]?Zero,1)
exten => s,n,GotoIf($["${id_fluxo}" != "NULL"]?Fluxo,1)
exten => s,n,MacroExit

; Caso nao encontre menu retorna zero
exten => Zero,1,Set(id_menu=0)
exten => Zero,2,MacroExit

;
exten => Fluxo,1,Set(OBJETO=ipbx_fluxograma_iniciador)
exten => Fluxo,n,Set(ID_FLUXO=${id_fluxo})
;exten => Fluxo,n,Set(ID_OBJETO=1)
exten => Fluxo,n,Goto(URA-Automatica,s,1) 

; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})
exten => h,3,NoOp()
exten => h,4,NoOp()

[macro-callback]
exten => s,1,NoOp("Usuario ligando: ${CALLERID(num)}")
exten => s,2,System(nohup /var/www/html/include/teclogica/callback.sh ${Entrega} ${CALLERID(num)} &)
exten => s,3,Hangup()

; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})
;exten => h,3,UnpauseQueueMember(,SIP/${CALLERID(num)})
exten => h,3,NoOp()
;exten => h,4,UnpauseQueueMember(,${RAMALPAUSADO})
exten => h,4,NoOp()

[macro-menuatend_prefixo]

exten => s,1,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,2,MYSQL(Query resultid ${connid} select ccmai.opc_dig, idpi.prefixo, length(idpi.prefixo) from cc_menu_atend_item ccmai, ipbx_desv_prefix idp, ipbx_desv_prefix_item idpi where ccmai.prefixo = idp.id_desv_prefix and idp.id_desv_prefix = idpi.id_desv_prefix and id_menu = '${ARG1}' and ccmai.prefixo != '' and ccmai.prefixo != 0)
exten => s,3,MYSQL(Fetch fetchid ${resultid} opc_sel prefixo qtd_carac)
exten => s,4,GotoIf($["${fetchid}" = "0"]?Sem_prefixo,1)
exten => s,5,GotoIf($["${prefixo}" = "${CALLERID(num):0:${qtd_carac}}"]?8)
exten => s,6,NoOp("${CALLERID(num)} - ${prefixo}")
exten => s,7,Goto(3)
exten => s,8,MYSQL(Clear ${resultid})
exten => s,9,MYSQL(Disconnect ${connid})
exten => s,10,MacroExit

; Retorna sem prefixo cadastrado.
exten => Sem_prefixo,1,Set(opc_sel="")
exten => Sem_prefixo,2,MYSQL(Clear ${resultid})
exten => Sem_prefixo,3,MYSQL(Disconnect ${connid})
exten => Sem_prefixo,4,MacroExit

; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})
;exten => h,3,UnpauseQueueMember(,SIP/${CALLERID(num)})
exten => h,3,NoOp()
;exten => h,4,UnpauseQueueMember(,${RAMALPAUSADO})
exten => h,4,NoOp()

[macro-gravacao]

exten => s,1,Set(DESTINO=${ARG2})

; Codigo identificando se ligacao foi transferida, caso houve transferencia executa codigo.
exten => s,2,NoOp("BLIND --------------------------------------> [${BLINDTRANSFER}]")
exten => s,3,GotoIf($[${EXISTS(${BLINDTRANSFER})}]?4:500)
exten => s,4,Wait(1)
exten => s,5,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,6,MYSQL(Query resultid ${connid} select uniqueid from cdr where channel = '${BLINDTRANSFER}' and calldate < DATE_SUB(now(), INTERVAL 10 SECOND) order by calldate desc limit 1 )
exten => s,7,MYSQL(Fetch fetchid ${resultid} IDCHAMADAANTERIOR)
exten => s,8,MYSQL(Clear ${resultid})
exten => s,9,MYSQL(Disconnect ${connid})
exten => s,10,GotoIf($["${fetchid}" == "0"]?s,500)
exten => s,11,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,12,MYSQL(Query resultid ${connid} select uniqueid_original, flg_grava from ipbx_transferencias where uniqueid_chamada = '${IDCHAMADAANTERIOR}' limit 1)
exten => s,13,MYSQL(Fetch fetchid ${resultid} IDCHAMADAORIGINAL FLGGRAVA)
exten => s,14,MYSQL(Clear ${resultid})
exten => s,15,MYSQL(Disconnect ${connid})

; Caso a chamada nao esteja na base adiciona.
exten => s,16,GotoIf($["${fetchid}" == "0"]?s,2000) 

; Se a chamada estava gravando, nao executa gravacao novamente.
exten => s,17,GotoIf($["${FLGGRAVA}" == "1" ]?s,100)
exten => s,18,Goto(500)

; Informa que ja estava gravando
exten => s,100,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,101,MYSQL(Query resultid ${connid} insert into ipbx_transferencias (uniqueid_original, uniqueid_chamada, flg_grava) values ('${IDCHAMADAORIGINAL}', '${UNIQUEID}', 1))
exten => s,102,MYSQL(Clear ${resultid})
exten => s,103,MYSQL(Disconnect ${connid})
exten => s,104,Goto(1000)

; Insere informacao dizendo que a chamada ja esta sendo gravada.
;exten => s,16,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
;exten => s,17,MYSQL(Query resultid ${connid} insert into ipbx_transferencias (uniqueid_original, uniqueid_chamada, flg_grava) values ('${IDCHAMADAORIGINAL}', '${UNIQUEID}', 1))
;exten => s,18,MYSQL(Clear ${resultid})
;exten => s,19,MYSQL(Disconnect ${connid})

; Adicionar na base de dados a chamada retroativamente.
exten => s,2000,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,2001,MYSQL(Query resultid ${connid} insert into ipbx_transferencias (uniqueid_original, uniqueid_chamada, flg_grava) values ('${IDCHAMADAORIGINAL}', '${IDCHAMADAANTERIOR}', '${FLGGRAVA}'))
exten => s,2002,MYSQL(Clear ${resultid})
exten => s,2003,MYSQL(Disconnect ${connid})
exten => s,2004,Goto(10)

; Ligacao nao transferida.
;exten => s,500,GotoIf($["${GRAVANDO}" != "" ]?1000)
exten => s,500,GotoIf($["${GRAVANDO}" = NO ]?1000)
exten => s,501,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,502,MYSQL(Query resultid ${connid} select grava_chamada from ipbx_ramais where name = '${ARG1}' or name = '${ARG2}' order by grava_chamada desc)
exten => s,503,NoOp()
exten => s,504,NoOp()
exten => s,505,MYSQL(Fetch fetchid ${resultid} grava_chamada)
exten => s,506,MYSQL(Clear ${resultid})
exten => s,507,MYSQL(Query resultid ${connid} select pasta from ipbx_conf_grav)
exten => s,508,MYSQL(Fetch fetchid ${resultid} PASTAGRAVCHAMADA)
exten => s,509,MYSQL(Clear ${resultid})
exten => s,510,MYSQL(Disconnect ${connid})

exten => s,511,GotoIf($["${grava_chamada}" = "0"]?1000)
exten => s,512,GotoIf($["${grava_chamada}" = "NULL"]?1000)
exten => s,513,Set(ARQGRAVACAO=${PASTAGRAVCHAMADA}/${UNIQUEID}.gsm)
; exten => s,513,Set(ARQGRAVACAO=${PASTAGRAVCHAMADA}/${UNIQUEID}.alaw)
exten => s,514,MixMonitor(${ARQGRAVACAO},b)
exten => s,515,Set(GRAVANDO=YES)
exten => s,516,Set(DESTINO=${ARG2})
exten => s,517,GotoIf($[${EXISTS(${BLINDTRANSFER})}]?1000:518)
exten => s,518,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,519,MYSQL(Query resultid ${connid} insert into ipbx_transferencias (uniqueid_original, uniqueid_chamada, flg_grava) values ('${UNIQUEID}', '${UNIQUEID}', 1))
exten => s,520,MYSQL(Clear ${resultid})
exten => s,521,MYSQL(Disconnect ${connid})
exten => s,522,MacroExit

exten => s,1000,MacroExit

; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})
;exten => h,3,UnpauseQueueMember(,SIP/${CALLERID(num)})
exten => h,3,NoOp()
;exten => h,4,UnpauseQueueMember(,${RAMALPAUSADO})
exten => h,4,NoOp()

[macro-rodizioInterf]

; ARG1 = Identif. Interface
; ARG2 = Board
; ARG3 = Numero de destino

exten => s,1,Set(CANAL_ANTERIOR=-)
exten => s,2,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,3,MYSQL(Query resultid ${connid} select trim(round(canal)) from ipbx_canais where id_interf='${ARG1}' order by rdz_interf)
exten => s,4,MYSQL(Fetch fetchid ${resultid} canal)
exten => s,5,NoOp("${fetchid}")
exten => s,6,Set(CALLERID(num)=${WRK_TEL_ORIGEM})

;exten => s,7,Dial(khomp/b${ARG2}c${canal}/${ARG3}/orig=restricted,50,TL(${LIMITEDETEMPO}))
exten => s,7,Dial(khomp/b${ARG2}c${canal}/${ARG3},50,TL(${LIMITEDETEMPO}))
exten => s,8,Goto(rodInterf,1)

; -- Tratamento para desligar
exten => rodInterf,1,NoOp()
exten => rodInterf,2,GotoIf($["${canal}" = "${CANAL_ANTERIOR}"]?100)
exten => rodInterf,3,Set(CANAL_ANTERIOR=${canal})
exten => rodInterf,4,Goto(s,4)
exten => rodInterf,100,MacroExit

; Hangup da ligacao fecha conexao com o banco de dados
;exten => h,1,UnpauseQueueMember(,SIP/${CALLERID(num)})
exten => h,1,NoOp()
exten => h,2,MYSQL(Query resultid ${connid} update ipbx_canais set rdz_interf=now() where id_interf='${ARG1}' and canal='${canal}')
exten => h,3,MYSQL(Clear ${resultid})
exten => h,4,MYSQL(Disconnect ${connid})
;exten => h,5,UnpauseQueueMember(,SIP/${CALLERID(num)})
exten => h,5,NoOp()
;exten => h,6,UnpauseQueueMember(,${RAMALPAUSADO})
exten => h,6,NoOp()
;exten => h,7,Set(CDR(userfield)=${ARG3},${ARG1})
exten => h,7,NoOp()
exten => h,8,GotoIf($["${GRAVANDO}" != "YES" ]?100)
exten => h,9,NoOp(${HANGUPCAUSE}-${DIALSTATUS})
exten => h,10,GotoIf($["${DIALSTATUS}" != "ANSWER" ]?100)
exten => h,11,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => h,12,MYSQL(Query resultid ${connid} insert into ipbx_gravacoes (tp_gravacao, dt_gravacao, nm_arq, num_destino, num_final, uniqueid) values ('${TIPORAMAL}', now(), '${ARQGRAVACAO}', '${CALLERID(num)}', '${DESTINO}', '${UNIQUEID}') )
exten => h,13,MYSQL(Clear ${resultid})
exten => h,14,MYSQL(Disconnect ${connid})
; exten => h,14,System(nohup /usr/bin/php /var/www/html/voip-webservice/cliente_RegistrarLog.php 0 ${WRK_TEL_DESTINO} ${WRK_TEL_ORIGEM} ${UNIQUEID} &)
exten => h,15,NoOp()
;exten => h,16,UnpauseQueueMember(,SIP/${CALLERID(num)})
exten => h,16,NoOp()
exten => h,17,GotoIf($["${RAMALPAUSADO}" == "" ]?18)
;exten => h,18,UnpauseQueueMember(,${RAMALPAUSADO})
exten => h,18,NoOp()


exten => h,100,NoOp("Sem Gravacoes para esta chamada")
; exten => h,101,System(nohup /usr/bin/php /var/www/html/voip-webservice/cliente_RegistrarLog.php 0 ${WRK_TEL_DESTINO} ${WRK_TEL_ORIGEM} ${UNIQUEID} &)
exten => h,101,NoOp()
;exten => h,102,UnpauseQueueMember(,SIP/${CALLERID(num)})
exten => h,102,NoOp()
exten => h,103,GotoIf($["${RAMALPAUSADO}" == "" ]?105)
;exten => h,104,UnpauseQueueMember(,${RAMALPAUSADO})
exten => h,104,NoOp()


[macro-menuatend]
; Argumento e o id_menu pego com a macro getid_menu

; Verifica se o menu possui prefixos cadastrados
exten => s,1,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,2,MYSQL(Query resultid ${connid} select count(ccmai.prefixo) from cc_menu_atend ccma, cc_menu_atend_item ccmai where ccma.id_menu=ccmai.id_menu and ccma.id_menu='${ARG1}' and prefixo != '')
exten => s,3,MYSQL(Fetch fetchid ${resultid} qtd_prefixo)
; exten => s,4,NoOp("${fetchid}")
exten => s,4,Answer()
exten => s,5,MYSQL(Clear ${resultid})
exten => s,6,MYSQL(Disconnect ${connid})
exten => s,7,GotoIf($["${qtd_prefixo}" = "0"]?menu_voz,1)

; Envia para rotina de menu com prefixo.
exten => s,8,Set(opc_sel="")
exten => s,9,Macro(menuatend_prefixo,${ARG1})
exten => s,10,GotoIf($["${opc_sel}" = ""]?menu_voz,1)
exten => s,11,Goto(identifica_opcao,2)

; rotina de menu de voz
exten => menu_voz,1,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => menu_voz,2,MYSQL(Query resultid ${connid} select ccma.arq_audio, ccma.flg_dig_ramal, ccma.nm_tentativas, ccma.destino from cc_menu_atend ccma where ccma.id_menu="${ARG1}")
exten => menu_voz,3,MYSQL(Fetch fetchid ${resultid} arq_audio flg_dig_ramal nm_tentativas destino)
exten => menu_voz,4,MYSQL(Clear ${resultid})
exten => menu_voz,5,MYSQL(Disconnect ${connid})
exten => menu_voz,6,Set(arq_audio=${CUT(arq_audio,.,1)})

; Configuracao de digito de ramais
exten => menu_voz,7,GotoIf($["${flg_dig_ramal}" = "0"]?menu_voz,20)
exten => menu_voz,8,Read(opc_sel,media/gsm/${arq_audio},4,,${nm_tentativas},2)
exten => menu_voz,9,NoOp(${LEN(${opc_sel})})
exten => menu_voz,10,GotoIf($[${LEN(${opc_sel})} > 1]?ramal-interno,${opc_sel},1)
exten => menu_voz,11,GotoIf($["${opc_sel}" != ""]?identifica_opcao,1)
exten => menu_voz,12,Goto(ramal-interno,${destino},1)
;exten => menu_voz,10,GotoIf($[${LEN(${opc_sel})} > 1]?ramal-interno,${opc_sel},1)
;exten => menu_voz,11,Goto(identifica_opcao,1)

; Sem a configuração de digito de ramais
exten => menu_voz,20,Read(opc_sel,media/gsm/${arq_audio},1,,${nm_tentativas},2)
exten => menu_voz,21,GotoIf($["${opc_sel}" != ""]?identifica_opcao,1)
exten => menu_voz,22,Goto(ramal-interno,${destino},1)

exten => identifica_opcao,1,SayDigits(${opc_sel})
exten => identifica_opcao,2,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => identifica_opcao,3,MYSQL(Query resultid ${connid} select ccmai.rdb_opcao, ccmai.id_cod_gen from cc_menu_atend ccma, cc_menu_atend_item ccmai where ccma.id_menu=ccmai.id_menu and ccma.id_menu="${ARG1}" and ccmai.opc_dig = "${opc_sel}")
exten => identifica_opcao,4,MYSQL(Fetch fetchid ${resultid} rdb_opcao id_cod_gen)
exten => identifica_opcao,5,MYSQL(Clear ${resultid})
exten => identifica_opcao,6,MYSQL(Disconnect ${connid})
exten => identifica_opcao,7,Goto(${rdb_opcao},1)

; Opcao de acoes 
; ---------------------------------------------------
exten => Acao,1,NoOp("Acao")
; Repete Menu
exten => Acao,2,GotoIf($["${id_cod_gen:4}" = "5"]?s,1)
; Automacao SIAESA
exten => Acao,3,GotoIf($["${id_cod_gen:4}" = "8"]?aut_siaesa,s,1)
; Automacao 
exten => Acao,4,GotoIf($["${id_cod_gen:4}" = "9"]?autatend_SCCelAcesso,s,1)
; Verifica se eh sala de conferencia
exten => Acao,5,GotoIf($["${id_cod_gen:4}" = "1"]?conferencia,conf_sala,1)
; Retorna Menu Anterior
exten => Acao,6,GotoIf($["${id_cod_gen:4}" = "6"]?7:8)
; Retorna Menu Anterior
exten => Acao,7,MacroExit
; Finaliza
exten => Acao,8,Hangup()

; ---------------------------------------------------
; Opcao de Ramais
; ---------------------------------------------------
exten => Ramal,1,NoOp("Ramal")
exten => Ramal,2,Goto(ramal-interno,${id_cod_gen:5},1)

; ---------------------------------------------------
; Chamada Recursiva de menus
; ---------------------------------------------------
exten => Menu,1,NoOp("Menu")
exten => Menu,2,Macro(menuatend,${id_cod_gen:4})
exten => Menu,3,Goto(s,1)

; ---------------------------------------------------
; Opcao de fila de atendimento
; ---------------------------------------------------

exten => Fila,1,NoOp()
exten => Fila,2,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => Fila,3,MYSQL(Query resultid ${connid} select nm_fila, gravacao, id_horario, arq_audio, arq_mesg, id_desvio, tp_excedido, acao_falta_agente, acao_tp_excedido,acao_fr_horario from cc_receptivo_filas where id_filas=${id_cod_gen:4})
exten => Fila,4,MYSQL(Fetch fetchid ${resultid} nm_fila gravacao id_horario arq_audio arq_mesg id_desvio tp_excedido acao_falta_agente acao_tp_excedido acao_fr_horario)
exten => Fila,5,MYSQL(Clear ${resultid})
exten => Fila,6,MYSQL(Disconnect ${connid})
exten => Fila,7,GotoIf($["${nm_fila}" = ""]?Fila,200)
exten => Fila,8,GotoIf($["${nm_fila}" = "NULL"]?Fila,200)

exten => Fila,9,NoOp("-------------- Verificar se eh data especifica ou feriado. ------------------")
exten => Fila,10,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => Fila,11,MYSQL(Query resultid ${connid} select count(*) as dt_espec from ipbx_dt_especifica_feriado where dt_especifica = DATE(now()))
exten => Fila,12,MYSQL(Fetch fetchid ${resultid} DT_ESPEC)
exten => Fila,13,NoOp("${DT_ESPEC}")
exten => Fila,14,MYSQL(Clear ${resultid})
exten => Fila,15,MYSQL(Disconnect ${connid})
exten => Fila,16,GotoIf($["${DT_ESPEC}" == "1"]?Fila,100)

exten => Fila,17,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => Fila,18,MYSQL(Query resultid ${connid} select count(*) from cc_receptivo_filas_horario_desv_ramais crfhdr where crfhdr.id_desvio=${id_desvio} and crfhdr.diasemana=DATE_FORMAT(curdate(),"%w")  and (time(CURTIME()) BETWEEN time(crfhdr.hr_inicio_01) and time(crfhdr.hr_fim_01) or time(CURTIME()) BETWEEN time(crfhdr.hr_inicio_02) and time(crfhdr.hr_fim_02) or time(CURTIME()) BETWEEN time(crfhdr.hr_inicio_03) and time(crfhdr.hr_fim_03) or time(CURTIME()) BETWEEN time(crfhdr.hr_inicio_04) and time(crfhdr.hr_fim_04)))
exten => Fila,19,MYSQL(Fetch fetchid ${resultid} flg_horario)
exten => Fila,20,MYSQL(Clear ${resultid})
exten => Fila,21,MYSQL(Disconnect ${connid})
exten => Fila,22,GotoIf($["${flg_horario}" = "0"]?Fora_horario,1)
exten => Fila,23,Goto(Entra_fila,1)

exten => Fila,100,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => Fila,101,MYSQL(Query resultid ${connid} select count(*) from cc_receptivo_filas_horario_desv_ramais crfhdr where crfhdr.id_desvio=${id_desvio} and crfhdr.diasemana is NULL and (time(CURTIME()) BETWEEN time(crfhdr.hr_inicio_01) and time(crfhdr.hr_fim_01) or time(CURTIME()) BETWEEN time(crfhdr.hr_inicio_02) and time(crfhdr.hr_fim_02) or time(CURTIME()) BETWEEN time(crfhdr.hr_inicio_03) and time(crfhdr.hr_fim_03) or time(CURTIME()) BETWEEN time(crfhdr.hr_inicio_04) and time(crfhdr.hr_fim_04)))
exten => Fila,102,MYSQL(Fetch fetchid ${resultid} flg_horario)
exten => Fila,103,MYSQL(Clear ${resultid})
exten => Fila,104,MYSQL(Disconnect ${connid})
exten => Fila,105,GotoIf($["${flg_horario}" = "0"]?Fora_horario,1)
exten => Fila,106,Goto(Entra_fila,1)

exten => Fila,200,NoOp("Nao encontrou fila, id_filas=${id_cod_gen:4})
exten => Fila,201,Hangup(6)

; Entrada na fila de atendimento
exten => Entra_fila,1,GotoIf($["${gravacao}" = "1"]?2:6)
;exten => Entra_fila,2,Set(GRAVANDO=YES)
exten => Entra_fila,2,Set(GRAVANDOFILA=YES)
;exten => Entra_fila,2,Noop()
exten => Entra_fila,3,Set(MONITOR_FILENAME=${PASTAGRAVCHAMADA}/${nm_fila}-${UNIQUEID})
exten => Entra_fila,4,Set(ARQGRAVACAO=${MONITOR_FILENAME}.gsm)
exten => Entra_fila,5,Playback(ipbx/gravacao)

; Informa mensagem de aviso de fila
exten => Entra_fila,6,GotoIf($["${arq_mesg}" != ""]?8:10)
exten => Entra_fila,7,GotoIf($["${arq_mesg}" != "NULL"]?8:10)
exten => Entra_fila,8,Set(arq_mesg=${CUT(arq_mesg,.,1)})
exten => Entra_fila,9,Playback(media/gsm/${arq_mesg})
exten => Entra_fila,10,Set(DESTINO=${nm_fila})
exten => Entra_fila,11,Set(QTD_AGENTE=${QUEUE_MEMBER_COUNT(${nm_fila})})
exten => Entra_fila,12,GoToIf($[${QTD_AGENTE} > 0]?Entra_fila,15)
exten => Entra_fila,13,GotoIf($["${acao_falta_agente}" = ""]?Entra_fila,50)
exten => Entra_fila,14,GotoIf($["${acao_falta_agente}" != "NULL"]?Entra_fila,50)
exten => Entra_fila,15,GotoIf($["${tp_excedido}" = ""]?Entra_fila,40)
exten => Entra_fila,16,GotoIf($["${tp_excedido}" = "NULL"]?Entra_fila,40)
exten => Entra_fila,17,Set(CALLERID(name)=${nm_fila}-${CALLERID(name)})
exten => Entra_fila,18,Queue(${nm_fila},t,,,${tp_excedido})
exten => Entra_fila,19,GotoIf($["${acao_tp_excedido}" = ""]?Entra_fila,30)
exten => Entra_fila,20,GotoIf($["${acao_tp_excedido}" = "NULL"]?Entra_fila,30)
exten => Entra_fila,21,GoTo(ramal-interno,${acao_tp_excedido},1)

exten => Entra_fila,30,Hangup()

exten => Entra_fila,40,Set(CALLERID(name)=${nm_fila}-${CALLERID(name)})
exten => Entra_fila,41,Queue(${nm_fila},t)
exten => Entra_fila,42,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => Entra_fila,43,MYSQL(Query resultid ${connid} insert into cc_receptivo_transbordo (queue_name, Telefone) values ('${nm_fila}', '${CALLERID(num)}'))
exten => Entra_fila,44,MYSQL(Fetch fetchid ${resultid} flg_horario)
exten => Entra_fila,45,MYSQL(Clear ${resultid})
exten => Entra_fila,46,MYSQL(Disconnect ${connid})


exten => Entra_fila,50,GoTo(ramal-interno,${acao_falta_agente},1)

;
; Fora do horario de atendimento.
exten => Fora_horario,1,GotoIf($["${acao_fr_horario}" = ""]?Fora_horario,3)
exten => Fora_horario,2,GotoIf($["${acao_fr_horario}" = "NULL"]?Fora_horario,4)
exten => Fora_horario,3,GoTo(ramal-interno,${acao_fr_horario},1)
exten => Fora_horario,4,Set(arq_audio=${CUT(arq_audio,.,1)})
exten => Fora_horario,5,Playback(media/gsm/${arq_audio})
exten => Fora_horario,6,Hangup()
; ---------------------------------------------------


; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})
;exten => h,3,UnpauseQueueMember(,SIP/${CALLERID(num)})
exten => h,3,NoOp()
exten => h,4,NoOp()
exten => h,5,NoOp()
exten => h,6,GotoIf($["${GRAVANDOFILA}" != "YES" ]?11)
exten => h,7,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => h,8,MYSQL(Query resultid ${connid} insert into ipbx_gravacoes (tp_gravacao, dt_gravacao, nm_arq, num_destino, num_final, uniqueid) values ('${TIPORAMAL}', now(), '${ARQGRAVACAO}', '${CALLERID(num)}', '${DESTINO}', '${UNIQUEID}') )
exten => h,9,MYSQL(Clear ${resultid})
exten => h,10,MYSQL(Disconnect ${connid})

exten => h,11,NoOp("Sem Gravacoes para esta chamada")


[macro-interfacedestino]

exten => s,1,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,2,MYSQL(Query resultid ${connid} select ir.id_interf, ir.ident_interf, ii.board, ii.link, irs.canal, ii.usuario, ii.id_tp_interf from ipbx_ramais ir left join ipbx_interf ii on ii.id_interf = ir.id_interf left join ipbx_canais irs on irs.id_canal = ir.ident_interf where ir.name = "${ARG1}")
exten => s,3,MYSQL(Fetch fetchid ${resultid} id_interf ident_interf board link canal usuario id_tp_interf)
exten => s,4,NoOp("${fetchid}")
exten => s,5,MYSQL(Clear ${resultid})
exten => s,6,MYSQL(Disconnect ${connid})
exten => s,7,GotoIf($["${id_interf}" = "NULL"]?100)
exten => s,8,GotoIf($["${board}" = "NULL"]?100)
exten => s,9,GotoIf($["${ident_interf}" = ""]?200)

; Khomp FXS - Falta acertar 
exten => s,10,Set(INTERFACE=Khomp/b${board}c${ident_interf})
exten => s,11,MacroExit

; Padrão SIP
exten => s,100,Set(INTERFACE=SIP)
exten => s,101,GotoIf($["${usuario}" = "NULL"]?110)
exten => s,102,GotoIf($["${id_tp_interf}" = "6"]?120)
exten => s,103,GotoIf($["${id_tp_interf}" = "9"]?125)
exten => s,104,GotoIf($["${id_tp_interf}" = "10"]?130)
exten => s,105,GotoIf($["${id_tp_interf}" = "11"]?115)
exten => s,110,MacroExit

; Interface Sip Generica
exten => s,115,Set(Entrega=sipgen_${usuario}/${Entrega})
exten => s,116,MacroExit

; Interface Sip 
exten => s,120,Set(Entrega=${usuario}/${Entrega})
exten => s,121,MacroExit

; Interface Sip MSLYNC
exten => s,125,Set(Entrega=mslync_${id_interf}/${Entrega})
exten => s,126,MacroExit

; Interface Sip MSLYNC
exten => s,130,Set(Entrega=interface_callman_${id_interf}/${Entrega})
exten => s,131,MacroExit

; Khomp E1 - Falta acertar
exten => s,200,Set(INTERFACE=Khomp/b${board}l${link})
exten => s,201,MacroExit

; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})

[fop2-park]
; Alternative fop2-park for asterisk 1.6 and up, using parkinglots and Park application
exten => _X.,1,Set(ARRAY(RETURN_EXTENSION,RETURN_CONTEXT)=${CUT(EXTEN,:,1)},${CUT(EXTEN,:,2)})
exten => _X.,n,Set(PARKINGLOT=parkinglot_${RETURN_CONTEXT})
exten => _X.,n,Park(,${RETURN_CONTEXT},${RETURN_EXTENSION},1,s)

[macro-identificaorigen]
; Identifica se o numero e listado na blacklist.
exten => s,1,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,2,MYSQL(Query resultid ${connid} select count(*) from blacklist where num_bl_list = "${ARG1}")
exten => s,3,MYSQL(Fetch fetchid ${resultid} blacklist)
exten => s,4,NoOp("${fetchid}")
exten => s,5,MYSQL(Clear ${resultid})
exten => s,6,MYSQL(Disconnect ${connid})
exten => s,7,GotoIf($[${blacklist} < 1]?11)
exten => s,8,HangUp()

; Identifica quem e a origem.
exten => s,11,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,12,MYSQL(Query resultid ${connid} select nome from agenda where numero like "%${ARG1:3}%")
exten => s,13,MYSQL(Fetch fetchid ${resultid} nome)
exten => s,14,NoOp("${fetchid}")
exten => s,15,MYSQL(Clear ${resultid})
exten => s,16,MYSQL(Disconnect ${connid})
exten => s,17,GotoIf($["${fetchid}" = "0"]?19)
exten => s,18,GotoIf($[${LEN(${CALLERID(num)})} < 5]?20)
exten => s,19,Set(CALLERID(name)=${nome})  
exten => s,20,MacroExit

; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})


[redirecionamentointeligente]

exten => s,1,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,2,MYSQL(Query resultid ${connid} select valor from parametros where nome = 'redirecionamentointeligente')
exten => s,3,MYSQL(Fetch fetchid ${resultid} REDIRECTINTEL)
exten => s,4,MYSQL(Clear ${resultid})
exten => s,5,MYSQL(Disconnect ${connid})
exten => s,6,GotoIf($["${REDIRECTINTEL}" = "1"]?100)
exten => s,7,MacroExit

exten => 100,1,NoOp()


; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})


[macro-ccusto]

exten => s,1,GotoIf($["${INFOCENTROCUSTO}" = "0"]?padrao,1)
exten => s,2,Read(custo,ipbx/ura_custo_pad,6,,,2)
exten => s,3,NoOp()
exten => s,4,GotoIf($["${custo}" = "*"]?padrao,1)
exten => s,5,GotoIf($[${LEN(${custo})} > 0]?ccustoconsulta,1)
exten => s,6,Goto(1)

exten => padrao,1,MacroExit

exten => ccustoconsulta,1,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => ccustoconsulta,2,MYSQL(Query resultid ${connid} select idt_custo from centrocusto where idt_custo=${custo} and flg_ativado = 1)
exten => ccustoconsulta,3,MYSQL(Fetch fetchid ${resultid} idt_custo)
exten => ccustoconsulta,4,MYSQL(Clear ${resultid})
exten => ccustoconsulta,5,MYSQL(Disconnect ${connid})
exten => ccustoconsulta,6,GotoIf($["${fetchid}" = "0"]?100)
exten => ccustoconsulta,7,Set(CDR(accountcode)=${idt_custo})
exten => ccustoconsulta,8,MacroExit

exten => ccustoconsulta,100,Goto(s,1)

; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})


[macro-sigame]

exten => s,1,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,2,MYSQL(Query resultid ${connid} select ir.desvio as desvio, su.context as contexto, su.accountcode conta from ipbx_ramais ir, sip_users su where ir.name = su.name and ir.name="${ARG1}")
exten => s,3,MYSQL(Fetch fetchid ${resultid} sigame_destino contexto conta)
exten => s,4,NoOp("${fetchid}")
exten => s,5,MYSQL(Clear ${resultid})
exten => s,6,MYSQL(Disconnect ${connid})
exten => s,7,GotoIf($["${sigame_destino}" = "NULL"]?1000)
exten => s,8,GotoIf($["${sigame_destino}" = ""]?1000)

; Ligação para ramal de origem
exten => s,1000,NoOp()
exten => s,1001,Set(Entrega=${ARG1})
exten => s,1002,MacroExit

; Ligação para outro ramal
exten => s,9,GotoIf($[${LEN(${sigame_destino})} > 4 ]?2000)
exten => s,10,NoOp()
exten => s,11,NoOp()
exten => s,12,Goto(ramal-interno,${sigame_destino},1)
exten => s,13,MacroExit

; Ligação para destino fora da empresa
exten => s,2000,Set(CALLERID(num)=${ARG1})
exten => s,2001,Set(CDR(accountcode)=${conta})
exten => s,2002,Goto(${contexto},${sigame_destino},1)

; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})

[macro-transbordo]

;exten => s,1,Answer()
exten => s,1,NoOp()
exten => s,2,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,3,MYSQL(Query resultid ${connid} select transbordo, tp_chamada from ipbx_ramais where name ="${ARG1}")
exten => s,4,MYSQL(Fetch fetchid ${resultid} transbordo tempo_chamada)
exten => s,5,MYSQL(Clear ${resultid})
exten => s,6,MYSQL(Disconnect ${connid})
exten => s,7,GotoIf($["${transbordo}" = "NULL"]?1000)
exten => s,8,GotoIf($["${transbordo}" = ""]?1000)
exten => s,9,Dial(${INTERFACE}/${ARG1},${tempo_chamada},${DIALTRANS})
exten => s,10,NoOp("Estado da chamada [${HANGUPCAUSE}]")
exten => s,11,GotoIf($["${HANGUPCAUSE}" = "16"]?desligar,1)
exten => s,12,Goto(1900)

;Desligar Chamada
exten => desligar,1,Hangup()

exten => s,1000,MacroExit

; Ligação para outro ramal
; Ligação para outro ramal
exten => s,1900,GotoIf($[${LEN(${transbordo})} > 4 ]?2000)
exten => s,1901,GotoIf($[${transbordo:1:2} = "*7" ]?2000)
exten => s,1902,Goto(ramal-interno,${transbordo},1)
exten => s,1903,MacroExit

; Ligação para destino fora da empresa
exten => s,2000,Set(CALLERID(num)=${ARG1})
exten => s,2001,Set(CDR(accountcode)=${conta})
exten => s,2002,Goto(${contexto},${transbordo},1)


; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})
exten => h,3,NoOp()
exten => h,4,NoOp()
exten => h,5,GotoIf($["${GRAVANDO}" != "YES" ]?100)
exten => h,6,NoOp(${HANGUPCAUSE}-${DIALSTATUS})
exten => h,7,GotoIf($["${DIALSTATUS}" != "ANSWER" ]?100)
exten => h,8,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => h,9,MYSQL(Query resultid ${connid} insert into ipbx_gravacoes (tp_gravacao, dt_gravacao, nm_arq, num_destino, num_final, uniqueid) values ('${TIPORAMAL}', now(), '${ARQGRAVACAO}', '${CALLERID(num)}', '${DESTINO}', '${UNIQUEID}') )
exten => h,10,NoOp()
exten => h,11,MYSQL(Clear ${resultid})
exten => h,12,MYSQL(Disconnect ${connid})
;exten => h,13,System(nohup /usr/bin/php /var/www/html/voip-webservice/cliente_RegistrarLog.php 1 ${CALLERID(num)} ${destino} ${UNIQUEID} &)
exten => h,13,NoOp()
;exten => h,14,UnpauseQueueMember(,SIP/${CALLERID(num)})
exten => h,14,NoOp()
exten => h,15,GotoIf($["${RAMALPAUSADO}" == "" ]?17)
;exten => h,16,UnpauseQueueMember(,${RAMALPAUSADO})
exten => h,16,NoOp()
exten => h,17,Hangup()

exten => h,100,NoOp("Sem Gravacoes para esta chamada")
;exten => h,101,System(nohup /usr/bin/php /var/www/html/voip-webservice/cliente_RegistrarLog.php 1 ${CALLERID(num)} ${destino} ${UNIQUEID} &)
exten => h,101,NoOp()
;exten => h,102,UnpauseQueueMember(,SIP/${CALLERID(num)})
exten => h,102,NoOp()
exten => h,103,GotoIf($["${RAMALPAUSADO}" == "" ]?105)
;exten => h,104,UnpauseQueueMember(,${RAMALPAUSADO})
exten => h,104,NoOp()
exten => h,105,Hangup()

[macro-cadeado]
exten => s,1,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,2,MYSQL(Query resultid ${connid} select flg_cadeado from ipbx_ramais where name="${CALLERID(num)}")
exten => s,3,MYSQL(Fetch fetchid ${resultid} flg_cadeado)
exten => s,4,GotoIf($[${LEN(${ARG1})} > 4]?1000)
exten => s,5,GotoIf($["${CALLERID(num)}" == ""]?1000)
exten => s,6,MYSQL(Clear ${resultid})
exten => s,7,MYSQL(Disconnect ${connid})
exten => s,8,GotoIf($["${flg_cadeado}" = "0"]?1000)
exten => s,9,Background(ipbx/ramal_bloqueado)
exten => s,10,hangup()
exten => s,11,MacroExit
exten => s,1000,MacroExit

; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})


[macro-informacoesdoramal]
exten => s,1,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,2,MYSQL(Query resultid ${connid} select ir.tp_ramal, ir.mail, ir.accountcode, ir.id_pesquisa, ir.flg_info_centrocusto, il.sigla from ipbx_ramais ir, ipbx_lang il where ir.id_lang = il.id_lang and ir.name = "${ARG1}")
exten => s,3,MYSQL(Fetch fetchid ${resultid} TIPORAMAL EMAILRAMAL CONTACUSTO ID_PESQUISA INFOCENTROCUSTO LANG)
exten => s,4,GotoIf($["${CDR(accountcode)}" != ""]?6)
exten => s,5,Set(CDR(accountcode)=${CONTACUSTO})
exten => s,6,MYSQL(Clear ${resultid})
exten => s,7,MYSQL(Disconnect ${connid})
; Tempo maximo de chamadas internas entre ramais 4 horas.
exten => s,8,Set(LIMITEDETEMPO=14400000)
exten => s,8,GotoIf($["${PILOTOINTERF}" != "" ]?12)
exten => s,9,Set(DIALTRANS=TtrL(${LIMITEDETEMPO}))
exten => s,10,Set(TPCHAMADA=45)
exten => s,11,Goto(20)
exten => s,12,Set(DIALTRANS=trL(${LIMITEDETEMPO}))
exten => s,13,Goto(20)

exten => s,20,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,21,MYSQL(Query resultid ${connid} select valor from parametros where nome = 'timeout_chamada')
exten => s,22,MYSQL(Fetch fetchid ${resultid} LIMITEDETEMPO)
exten => s,23,MYSQL(Clear ${resultid})
exten => s,24,MYSQL(Disconnect ${connid})
exten => s,25,Set(CHANNEL(language)=${LANG})
exten => s,26,MacroExit


; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})

[macro-faixahorario]
; Entrada de chamadas identificação se existem desvios para o ramal 

exten => s,1,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,2,MYSQL(Query resultid ${connid} select seg,ter,qua,qui,sex,sab,dom,DATE_FORMAT(curdate(),"%w"),TIME_FORMAT(hr_inicio_01,"%H:%i"),TIME_FORMAT(hr_fim_01,"%H:%i"), TIME_FORMAT(hr_inicio_02,"%H:%i"),TIME_FORMAT(hr_fim_02,"%H:%i") from horario, ipbx_ramais where ipbx_ramais.name="${ARG1}" and ipbx_ramais.id_horario <> "" and horario.id_horario = ipbx_ramais.id_horario and ( time(CURTIME()) BETWEEN time(hr_inicio_01) and time(hr_fim_01) or time(CURTIME()) BETWEEN time(hr_inicio_02) and time(hr_fim_02) ))
exten => s,3,MYSQL(Fetch fetchid ${resultid} seg ter qua qui sex sab dom diasemana inicio_1 termino_1 inicio_2 termino_2)
exten => s,4,NoOp("${fetchid}")
exten => s,5,GotoIf($["${fetchid}" = "0"]?1000)
exten => s,6,Goto(10)

exten => s,10,GotoIf($["${diasemana}" = "0"]?20:11)
exten => s,11,GotoIf($["${diasemana}" = "1"]?21:12)
exten => s,12,GotoIf($["${diasemana}" = "2"]?22:13)
exten => s,13,GotoIf($["${diasemana}" = "3"]?23:14)
exten => s,14,GotoIf($["${diasemana}" = "4"]?24:15)
exten => s,15,GotoIf($["${diasemana}" = "5"]?25:16)
exten => s,16,GotoIf($["${diasemana}" = "6"]?26:17)
exten => s,17,Goto(3)

exten => s,20,GotoIf($["${dom}" = "0"]?desliga,1:disca,1)
exten => s,21,GotoIf($["${seg}" = "0"]?desliga,1:disca,1)
exten => s,22,GotoIf($["${ter}" = "0"]?desliga,1:disca,1)
exten => s,23,GotoIf($["${qua}" = "0"]?desliga,1:disca,1)
exten => s,24,GotoIf($["${qui}" = "0"]?desliga,1:disca,1)
exten => s,25,GotoIf($["${sex}" = "0"]?desliga,1:disca,1)
exten => s,26,GotoIf($["${sab}" = "0"]?desliga,1:disca,1)
exten => s,27,Goto(Desliga,1)

exten => desliga,1,MYSQL(Clear ${resultid})
exten => desliga,2,MYSQL(Disconnect ${connid})
exten => desliga,3,Playback(ipbx/hor_n_autoriz)
exten => desliga,4,Hangup()

exten => disca,1,NoOp("Discar para: ${ARG1}")
exten => disca,2,Set(Entrega=${ARG1})
exten => disca,3,MYSQL(Clear ${resultid})
exten => disca,4,MYSQL(Disconnect ${connid})
exten => disca,5,MacroExit

; Caso nao tenha regras dica para ramal do usuario
;exten => s,1000,Goto(disca,1)
exten => s,1000,NoOp()
exten => s,1001,MYSQL(Clear ${resultid})
exten => s,1002,MYSQL(Disconnect ${connid})
exten => s,1003,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => s,1004,MYSQL(Query resultid ${connid} select name from ipbx_ramais where name ="${ARG1}" and id_horario <> "")
exten => s,1005,MYSQL(Fetch fetchid ${resultid} nome)
exten => s,1006,GotoIf($["${fetchid}" = "0"]?1100) 
exten => s,1007,Goto(desliga,1)
exten => s,1100,Goto(disca,1)

; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})

; -------------------- configuracoes de rotinas

[conferencia]

; Conferencia
exten => conf_sala,1,NoOp("sala de conferencia")
;exten => conf_sala,1,Set(CHANNEL(language)=pt_BR)
exten => conf_sala,2,Playback(ipbx/conf_sala_bem_vindo)
exten => conf_sala,3,Read(id_conf,ipbx/conf_sala_identificador,6,,3,6)
exten => conf_sala,4,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
;exten => conf_sala,5,MYSQL(Query resultid ${connid} select dt_expiracao, senha, flg_rec from conf_sala where dt_expiracao > now() and id_conf="${id_conf}")
exten => conf_sala,5,MYSQL(Query resultid ${connid} select dt_expiracao, senha, flg_rec from conf_sala where concat(dt_expiracao,' ', hr_fim) > now() and id_conf="${id_conf}")
exten => conf_sala,6,MYSQL(Fetch fetchid ${resultid} dt_expiracao senha flg_rec)
exten => conf_sala,7,MYSQL(Clear ${resultid})
exten => conf_sala,8,MYSQL(Disconnect ${connid})
;exten => conf_sala,9,GotoIf($["${fetchid}" = "0"]?conf_sala,3)
exten => conf_sala,9,GotoIf($["${fetchid}" = "0"]?conf_sala,23)
exten => conf_sala,10,GotoIf($["${senha}" != ""]?20)
exten => conf_sala,11,GotoIf($["${flg_rec}" != "0"]?30)
exten => conf_sala,12,MeetMe(${id_conf},dM)

; Senha
exten => conf_sala,20,Read(usrsenha,ipbx/conf_sala_senha,6,,3,2)
exten => conf_sala,21,GotoIf($["${senha}" = "${usrsenha}" ]?11)
exten => conf_sala,22,NoOp("${senha}")
;exten => conf_sala,23,Goto(20)
exten => conf_sala,23,HangUp()

; Gravacao
exten => conf_sala,30,Set(ARQGRAVACAO=${PASTAGRAVCHAMADA}/Meetme-${id_conf}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}.gsm)
exten => conf_sala,31,Set(MEETME_RECORDINGFILE=${PASTAGRAVCHAMADA}/Meetme-${id_conf}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)})
exten => conf_sala,32,Set(MEETME_RECORDINGFORMAT=gsm)
exten => conf_sala,33,Set(GRAVANDO=YES)
exten => conf_sala,34,MeetMe(${id_conf},rdM)


; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})
exten => h,3,NoOp()
exten => h,4,NoOp(${DIALSTATUS})
exten => h,5,GotoIf($["${GRAVANDO}" != "YES"]?100)
exten => h,6,NoOp(${HANGUPCAUSE}-${DIALSTATUS})
;exten => h,7,GotoIf($["${DIALSTATUS}" != "ANSWER" ]?100)
exten => h,7,NoOp()
exten => h,8,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => h,9,MYSQL(Query resultid ${connid} insert into ipbx_gravacoes (tp_gravacao, dt_gravacao, nm_arq, num_destino, num_final, uniqueid) values ('${TIPORAMAL}', now(), '${ARQGRAVACAO}', '${CALLERID(num)}', '${DESTINO}', '${UNIQUEID}') )
exten => h,10,NoOp()
exten => h,11,MYSQL(Clear ${resultid})
exten => h,12,MYSQL(Disconnect ${connid})
; exten => h,13,System(nohup /usr/bin/php /var/www/html/voip-webservice/cliente_RegistrarLog.php 1 ${CALLERID(num)} ${destino} ${UNIQUEID} &)
exten => h,13,NoOp()
;exten => h,14,UnpauseQueueMember(,SIP/${CALLERID(num)})
exten => h,14,NoOp()
exten => h,15,GotoIf($["${RAMALPAUSADO}" == "" ]?17)
;exten => h,16,UnpauseQueueMember(,${RAMALPAUSADO})
exten => h,16,NoOp()
exten => h,17,Hangup()


exten => h,100,NoOp("Sem Gravacoes para esta chamada")
; exten => h,101,System(nohup /usr/bin/php /var/www/html/voip-webservice/cliente_RegistrarLog.php 1 ${CALLERID(num)} ${destino} ${UNIQUEID} &)
exten => h,101,NoOp()
;exten => h,102,UnpauseQueueMember(,SIP/${CALLERID(num)})
exten => h,102,NoOp()
exten => h,103,GotoIf($["${RAMALPAUSADO}" == "" ]?105)
;exten => h,104,UnpauseQueueMember(,${RAMALPAUSADO})
exten => h,104,NoOp()
exten => h,105,Hangup()

[sigame]

exten => _*1XXX.,1,Answer()
exten => _*1XXX.,2,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => _*1XXX.,3,MYSQL(Query resultid ${connid} update ipbx_ramais set desvio="${EXTEN:2}" where name = "${CALLERID(num)}")
exten => _*1XXX.,4,MYSQL(Fetch fetchid ${resultid})
exten => _*1XXX.,5,MYSQL(Clear ${resultid})
exten => _*1XXX.,6,MYSQL(Disconnect ${connid})
exten => _*1XXX.,7,Playback(beep)
exten => _*1XXX.,8,HangUp()

exten => _*2,1,Answer()
exten => _*2,2,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => _*2,3,MYSQL(Query resultid ${connid} update ipbx_ramais set desvio=NULL where name = "${CALLERID(num)}")
exten => _*2,4,MYSQL(Fetch fetchid ${resultid})
exten => _*2,5,MYSQL(Clear ${resultid})
exten => _*2,6,MYSQL(Disconnect ${connid})
exten => _*2,7,Playback(beep)
exten => _*2,8,HangUp()

; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})

[pickup-ligacao]
exten => _*8XXXX,1,PickUp(${EXTEN:2})
exten => _*8XXXX,2,PickUp(${EXTEN:2}@RAMAL)
exten => _*8XXXX,3,PickUp(${EXTEN:2}@ramal-interno)

[ext-meetme]
exten => _8XXXX,1,Answer()
exten => _8XXXX,2,Wait(1)
exten => _8XXXX,3,NoOp()

exten => _8XXXX,4,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => _8XXXX,5,MYSQL(Query resultid ${connid} select il.sigla from ipbx_ramais ir, ipbx_lang il where ir.id_lang = il.id_lang and ir.name ="${EXTEN:1}")
exten => _8XXXX,6,MYSQL(Fetch fetchid ${resultid} LANG)
exten => _8XXXX,7,MYSQL(Clear ${resultid})
exten => _8XXXX,8,MYSQL(Disconnect ${connid})

exten => _8XXXX,9,Set(CHANNEL(language)=${LANG})
exten => _8XXXX,10,GotoIf($[${CALLERID(num)}=${EXTEN:1}]?12)
exten => _8XXXX,11,MeetMe(${EXTEN},asdMc)
exten => _8XXXX,12,MeetMe(${EXTEN},sdMc)

; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})

[CONTATOS]

exten => _RIXXXX,1,Goto(ramal-interno,${EXTEN:-4},1)

exten => _X.,1,Answer()
exten => _X.,2,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => _X.,3,MYSQL(Query resultid ${connid} select idt_agenda, numero, custo.idt_custo from agenda, centrocusto custo where numero="${EXTEN}" and agenda.idt_custo=custo.idt_custo and custo.flg_ativado=1)
exten => _X.,4,MYSQL(Fetch fetchid ${resultid} idt_agenda numero idt_custo)
exten => _X.,5,MYSQL(Clear ${resultid})
exten => _X.,6,MYSQL(Disconnect ${connid})
exten => _X.,7,NoOp("${fetchid}")
exten => _X.,8,GotoIf($["${fetchid}" = "0"]?1000)
exten => _X.,9,Set(CDR(accountcode)=${idt_custo})
exten => _X.,10,Goto(DiscaContatos,${numero},1)
exten => _X.,1000,Playback(ipbx/id_ou_custo_inexistente)
exten => _X.,1001,hangup()

; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})

[DiscaContatos]

include => P1P2P3P4P5P6

[agenda-contatos]

exten => _*7.,1,Answer()
exten => _*7.,2,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => _*7.,3,MYSQL(Query resultid ${connid} select idt_agenda, numero, custo.idt_custo from agenda, centrocusto custo where idt_agenda="${EXTEN:2}" and agenda.idt_custo=custo.idt_custo and custo.flg_ativado=1)
exten => _*7.,4,MYSQL(Fetch fetchid ${resultid} idt_agenda numero idt_custo)
exten => _*7.,5,MYSQL(Clear ${resultid})
exten => _*7.,6,MYSQL(Disconnect ${connid})
exten => _*7.,7,NoOp("${fetchid}")
exten => _*7.,8,GotoIf($["${fetchid}" = "0"]?1000)
exten => _*7.,9,Set(CDR(accountcode)=${idt_custo})
exten => _*7.,10,Goto(DiscaContatos,${numero},1)
exten => _*7.,1000,Playback(ipbx/id_ou_custo_inexistente)
exten => _*7.,1001,hangup()

; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})

[ramal-interno]
include => agente
;include => ext-meetme

; Ramal Operadora
exten => 9,1,Answer()
exten => 9,2,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => 9,3,MYSQL(Query resultid ${connid} select valor from parametros where nome = 'telefoneoperador')
exten => 9,4,MYSQL(Fetch fetchid ${resultid} operador)
exten => 9,5,MYSQL(Clear ${resultid})
exten => 9,6,MYSQL(Disconnect ${connid})
exten => 9,7,Goto(ramal-interno,${operador},1)

exten => 0,1,Answer()
exten => 0,2,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => 0,3,MYSQL(Query resultid ${connid} select valor from parametros where nome = 'telefoneoperador')
exten => 0,4,MYSQL(Fetch fetchid ${resultid} operador)
exten => 0,5,MYSQL(Clear ${resultid})
exten => 0,6,MYSQL(Disconnect ${connid})
exten => 0,7,Goto(ramal-interno,${operador},1)

; Entrada de chamadas na central via MCDU
exten => _XXXX,1,Set(CUSTO={CDR(accountcode)})

; Caso receber ligação de fora
exten => _XXXX,2,macro(identificaorigen,${CALLERID(num)})
exten => _XXXX,3,GotoIf($["${PILOTOINTERF}" != "" ]?6)
exten => _XXXX,4,Set(CDR(accountcode)=0)
exten => _XXXX,5,macro(cadeado,${CALLERID(num)})
exten => _XXXX,6,macro(gravacao,${CALLERID(num)},${EXTEN})
exten => _XXXX,7,macro(informacoesdoramal,${EXTEN})
exten => _XXXX,8,macro(sigame,${EXTEN})
exten => _XXXX,9,macro(desvio-programado,${EXTEN})
exten => _XXXX,10,macro(interfacedestino,${Entrega})
exten => _XXXX,11,GotoIf($["${TIPORAMAL}" = "RAMAL"]?40)
exten => _XXXX,12,GotoIf($["${TIPORAMAL}" = "FAX"]?30)
exten => _XXXX,13,GotoIf($["${TIPORAMAL}" = "CALLBACK"]?20)
exten => _XXXX,14,GotoIf($["${TIPORAMAL}" = "MENU"]?50)
exten => _XXXX,15,GotoIf($["${TIPORAMAL}" = "CONFERENCIA"]?60)
exten => _XXXX,16,GotoIf($["${TIPORAMAL}" = "PESQUISA"]?17)

; -- Pesquisa
exten => _XXXX,17,NoOp("Pesquisa de satisfacao")
exten => _XXXX,18,Macro(pesquisa)

; -- Conferencia 
exten => _XXXX,60,Goto(conferencia,conf_sala,1)

; --  Codigo para menu de atendimento
;exten => _XXXX,50,Macro(redirecionamentointeligente)
exten => _XXXX,50,NoOp()
exten => _XXXX,51,Macro(getid_menu,${Entrega})
exten => _XXXX,52,GotoIf($["${id_menu}" = "0"]?13)
exten => _XXXX,53,Macro(menuatend,${id_menu})
exten => _XXXX,54,Hangup()

; -- Logica de Callback
exten => _XXXX,20,Macro(callback)

; -- Logica de FAX
exten => _XXXX,30,Answer()
exten => _XXXX,31,Goto(rc-hylafax,fax,1)

; Configurar RAMAL
;exten => _XXXX,40,macro(transferencia)
exten => _XXXX,40,NoOp()
exten => _XXXX,41,macro(transbordo,${Entrega})
exten => _XXXX,42,Dial(${INTERFACE}/${Entrega},${TPCHAMADA},${DIALTRANS})
exten => _XXXX,43,NoOp("Estado da chamada [${HANGUPCAUSE}]")
exten => _XXXX,44,GotoIf($["${HANGUPCAUSE}" = "16"]?desligar,1)
exten => _XXXX,45,GotoIf($["${EMAILRAMAL}" = ""]?1000)
exten => _XXXX,46,GotoIf($["${EMAILRAMAL}" = "NULL"]?1000)
exten => _XXXX,47,Voicemail(${Entrega})

;Desligar Chamada
exten => desligar,1,Hangup()

; exten => _XXXX,1000,Goto(ramal-interno,${PILOTOINTERF},1)
;exten => _XXXX,1000,Set(ULTIMORAMAL="${ULTIMORAMAL}")
exten => _XXXX,1000,NoOp("${ULTIMORAMAL}")
exten => _XXXX,1001,GotoIf($["${ULTIMORAMAL}" = "${Entrega}"]?1010)
exten => _XXXX,1002,NoOp("[${ULTIMORAMAL}] - [${Entrega}]")
exten => _XXXX,1003,Set(ULTIMORAMAL=${Entrega})
exten => _XXXX,1004,Set(PILOTOINTERF=${PILOTOINTERF})
exten => _XXXX,1005,GotoIf($["${PILOTOINTERF}" = ""]?1010)
exten => _XXXX,1006,Goto(ramal-interno,${PILOTOINTERF},1)
exten => _XXXX,1010,Playback(busy)
exten => _XXXX,1011,macro(tratadeslchamada)

exten => i,1,Set(CDR(accountcode)=0)
exten => i,2,NoOp("Voce nao possui privilegio para realizar esta ligacao.")
exten => i,3,Playback(ipbx/n_privilegio)
;exten => i,4,UnpauseQueueMember(,SIP/${CALLERID(num)})
exten => i,4,NoOp()
exten => i,5,Hangup(1)

; Hangup da ligacao fecha conexao com o banco de dados
exten => h,1,MYSQL(Clear ${resultid})
exten => h,2,MYSQL(Disconnect ${connid})
exten => h,3,NoOp()
exten => h,4,NoOp()
exten => h,5,GotoIf($["${GRAVANDO}" != "YES" ]?100)
exten => h,6,NoOp(${HANGUPCAUSE}-${DIALSTATUS})
exten => h,7,GotoIf($["${DIALSTATUS}" != "ANSWER" ]?100)
exten => h,8,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => h,9,MYSQL(Query resultid ${connid} insert into ipbx_gravacoes (tp_gravacao, dt_gravacao, nm_arq, num_destino, num_final, uniqueid) values ('${TIPORAMAL}', now(), '${ARQGRAVACAO}', '${CALLERID(num)}', '${DESTINO}', '${UNIQUEID}') )
exten => h,10,NoOp()
exten => h,11,MYSQL(Clear ${resultid})
exten => h,12,MYSQL(Disconnect ${connid})
; exten => h,13,System(nohup /usr/bin/php /var/www/html/voip-webservice/cliente_RegistrarLog.php 1 ${CALLERID(num)} ${destino} ${UNIQUEID} &)
exten => h,13,NoOp()
;exten => h,14,UnpauseQueueMember(,SIP/${CALLERID(num)})
exten => h,14,NoOp()
exten => h,15,GotoIf($["${RAMALPAUSADO}" == "" ]?17)
exten => h,16,NoOp()
;exten => h,16,UnpauseQueueMember(,${RAMALPAUSADO})
exten => h,17,Hangup()


exten => h,100,NoOp("Sem Gravacoes para esta chamada")
; exten => h,101,System(nohup /usr/bin/php /var/www/html/voip-webservice/cliente_RegistrarLog.php 1 ${CALLERID(num)} ${destino} ${UNIQUEID} &)
exten => h,101,NoOp()
;exten => h,102,UnpauseQueueMember(,SIP/${CALLERID(num)})
exten => h,102,NoOp()
exten => h,103,GotoIf($["${RAMALPAUSADO}" == "" ]?105)
;exten => h,104,UnpauseQueueMember(,${RAMALPAUSADO})
exten => h,104,NoOp()

[cadeado]
; habilita
exten => _*3XXXX.,1,Answer()
exten => _*3XXXX.,2,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => _*3XXXX.,3,MYSQL(Query resultid ${connid} update ipbx_ramais set flg_cadeado = 1 where name = "${CALLERID(num)}" and secret="${EXTEN:2}")
exten => _*3XXXX.,4,MYSQL(Fetch fetchid ${resultid})
exten => _*3XXXX.,5,MYSQL(Clear ${resultid})
exten => _*3XXXX.,6,MYSQL(Disconnect ${connid})
exten => _*3XXXX.,7,Playback(beep)
exten => _*3XXXX.,8,HangUp()

; desabilita
exten => _*4XXXX.,1,Answer()
exten => _*4XXXX.,2,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => _*4XXXX.,3,MYSQL(Query resultid ${connid} update ipbx_ramais set flg_cadeado = 0 where name = "${CALLERID(num)}" and secret="${EXTEN:2}")
exten => _*4XXXX.,4,MYSQL(Fetch fetchid ${resultid})
exten => _*4XXXX.,5,MYSQL(Clear ${resultid})
exten => _*4XXXX.,6,MYSQL(Disconnect ${connid})
exten => _*4XXXX.,7,Playback(beep)
exten => _*4XXXX.,8,HangUp()

[voicemail]

exten => *9,1,Answer()
exten => *9,2,Playback(silence/2)
exten => *9,3,VoicemailMain(${CALLERID(num)})

; PLANOS DE DISCAGEM -------------------------------------------------

[RAMAL]
include => ramal-interno
include => sigame
include => ext-meetme
include => pickup-ligacao
include => agenda-contatos
include => cadeado
include => voicemail
include => agente

; Plano de discagem de filas - Login de usuario

[DISCAGEM-FILAS]

include => RAMAL

exten => _.,1,NoOp("Ligacao remota")
exten => _.,2,MYSQL(Connect connid 127.0.0.1 asteriskuser asteriskuser asteriskcdrdb)
exten => _.,3,MYSQL(Query resultid ${connid} select id_chamada where flg_logon_remoto = 1)
exten => _.,4,MYSQL(Fetch fetchid ${resultid} ID_CHAMADA)
exten => _.,5,MYSQL(Clear ${resultid})
exten => _.,6,MYSQL(Disconnect ${connid})
exten => _.,7,Set(CALLERID(num)=${ID_CHAMADA})
exten => _.,8,Goto(${EXTEN},P1P2P3P4P5P6,1)

[MOBILE-CONF-DIAL]

exten => _.,1,NoOp(${EXTEN:1:4})
exten => _.,2,NoOp(${EXTEN:6})

exten => _.,3,Set(CALLERID(num)=${EXTEN:1:4})
exten => _.,4,Goto(P1P2P3P4P5P6,${EXTEN:6},1)

[ANDROID_CONF_MSG]

exten => _.,1,NoOp("Mensagem de aviso do Paulo e Guilherme.")
exten => _.,2,NoOp("---------------------------------------")
exten => _.,3,Set(opc_sel=9)
exten => _.,4,Set(CHANNEL(language)=pt_BR)
exten => _.,5,Read(opc_sel,android/msg_conf_android,4,,6,1)
exten => _.,6,NoOp(${LEN(${opc_sel})})
exten => _.,7,GotoIf($["${opc_sel}" == "1"]?P1P2P3P4P5P6,${EXTEN},1)
exten => _.,8,Hangup()
